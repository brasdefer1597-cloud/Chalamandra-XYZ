document.addEventListener('DOMContentLoaded', () => {
    const keyInput = document.getElementById('api-key-input');
    const textInput = document.getElementById('analysis-text');
    const btn = document.getElementById('analyze-button');
    const resBox = document.getElementById('result-container');
    const errorMsg = document.getElementById('error-message');

    // Cargar datos guardados
    chrome.storage.sync.get(['geminiApiKey'], (r) => { if(r.geminiApiKey) keyInput.value = r.geminiApiKey; });
    chrome.storage.local.get(['selectedText'], (r) => { if(r.selectedText) { textInput.value = r.selectedText; chrome.storage.local.remove('selectedText'); } });

    // Guardar Key al escribir
    keyInput.addEventListener('input', (e) => chrome.storage.sync.set({ geminiApiKey: e.target.value.trim() }));

    // Habilitar botón siempre (para evitar que se quede gris)
    btn.disabled = false;

    btn.addEventListener('click', () => {
        const text = textInput.value.trim();
        const key = keyInput.value.trim();
        
        if(!key) { errorMsg.textContent = "⚠️ Pega tu Google API Key primero"; errorMsg.classList.remove('hidden'); return; }
        if(!text) { errorMsg.textContent = "⚠️ Escribe algo para analizar"; errorMsg.classList.remove('hidden'); return; }

        // Estado de Carga
        btn.disabled = true;
        btn.textContent = "COMPUTING...";
        resBox.classList.add('hidden');
        errorMsg.classList.add('hidden');

        // Enviar al Background
        chrome.runtime.sendMessage({
            action: "runDashboardAnalysis",
            text: text,
            thesisStyle: document.getElementById('thesis-select').value,
            antithesisStyle: document.getElementById('antithesis-select').value
        }, (response) => {
            btn.disabled = false;
            btn.textContent = "GENERATE SYNTHESIS";

            if (chrome.runtime.lastError || (response && response.error)) {
                errorMsg.textContent = "⚠️ Error: " + (response?.errorMsg || "Fallo de conexión. Recarga.");
                errorMsg.classList.remove('hidden');
            } else if (response) {
                document.getElementById('res-thesis-text').textContent = response.thesis;
                document.getElementById('res-antithesis-text').textContent = response.antithesis;
                document.getElementById('res-synthesis-text').textContent = response.synthesis;
                resBox.classList.remove('hidden');
            }
        });
    });
});

